{% extends "base.html" %}

{% block title %}Settings - PolyHunter{% endblock %}

{% block extra_styles %}
<style>
    .settings-container {
        max-width: 720px;
    }

    .settings-header {
        margin-bottom: 32px;
    }

    .settings-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .settings-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .settings-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius);
        padding: 28px;
        margin-bottom: 24px;
    }

    .settings-card-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .settings-card-desc {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 24px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .form-input {
        padding: 11px 14px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        outline: none;
        transition: all 0.2s;
        width: 100%;
    }

    .form-input:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 165, 181, 0.1);
    }

    .form-input::placeholder {
        color: var(--text-muted);
    }

    .form-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .form-select {
        padding: 11px 14px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        outline: none;
        transition: all 0.2s;
        width: 100%;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238ba8be' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        padding-right: 36px;
    }

    .form-select:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 165, 181, 0.1);
    }

    .form-textarea {
        padding: 11px 14px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        font-family: 'Inter', sans-serif;
        outline: none;
        transition: all 0.2s;
        width: 100%;
        min-height: 100px;
        resize: vertical;
    }

    .form-textarea:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 165, 181, 0.1);
    }

    .form-textarea::placeholder {
        color: var(--text-muted);
    }

    .save-btn {
        padding: 12px 32px;
        background: linear-gradient(135deg, #3ba5b5, #0dd3ce);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .save-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(59, 165, 181, 0.3);
    }

    .save-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .save-row {
        display: flex;
        justify-content: flex-end;
        margin-top: 24px;
    }

    .settings-message {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 20px;
        display: none;
    }

    .settings-message.success {
        display: block;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        color: var(--accent-green);
    }

    .settings-message.error {
        display: block;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        color: var(--accent-red);
    }

    .avatar-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .avatar-large {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: 700;
        color: var(--accent-blue);
        flex-shrink: 0;
    }

    .avatar-info h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .avatar-info p {
        font-size: 13px;
        color: var(--text-muted);
    }

    .danger-btn {
        padding: 10px 20px;
        background: transparent;
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 8px;
        color: var(--accent-red);
        font-size: 13px;
        font-weight: 500;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: all 0.2s;
    }

    .danger-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--accent-red);
    }

    @media (max-width: 640px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .settings-card {
            padding: 20px;
        }

        .avatar-section {
            flex-direction: column;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header blur-fade" style="--delay: 0">
        <h1 class="settings-title">Settings</h1>
        <p class="settings-subtitle">Manage your account and preferences</p>
    </div>

    <div id="settingsMessage" class="settings-message"></div>

    <!-- Profile Settings -->
    <div class="settings-card animated-border-box blur-fade" style="--delay: 1">
        <h2 class="settings-card-title">Profile Settings</h2>
        <p class="settings-card-desc">Update your personal information and preferences</p>

        <div class="avatar-section">
            <div class="avatar-large" id="avatarInitial">?</div>
            <div class="avatar-info">
                <h3 id="profileName">Loading...</h3>
                <p id="profileEmail">Loading...</p>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Display Name</label>
                <input type="text" class="form-input" id="displayName" placeholder="Your display name">
            </div>

            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" id="emailAddress" disabled placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label class="form-label">Timezone</label>
                <select class="form-select" id="timezone">
                    <option value="America/New_York">Eastern Time (ET)</option>
                    <option value="America/Chicago">Central Time (CT)</option>
                    <option value="America/Denver">Mountain Time (MT)</option>
                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    <option value="Europe/London">London (GMT)</option>
                    <option value="Europe/Paris">Central European (CET)</option>
                    <option value="Europe/Moscow">Moscow (MSK)</option>
                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                    <option value="Asia/Shanghai">China (CST)</option>
                    <option value="Asia/Kolkata">India (IST)</option>
                    <option value="Australia/Sydney">Sydney (AEST)</option>
                    <option value="UTC">UTC</option>
                </select>
            </div>

            <div class="form-group full-width">
                <label class="form-label">Trading Bio</label>
                <textarea class="form-textarea" id="tradingBio" placeholder="Describe your trading style, favorite markets, etc."></textarea>
            </div>
        </div>

        <div class="save-row">
            <button class="save-btn" id="saveProfileBtn" onclick="saveProfile()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                Save Changes
            </button>
        </div>
    </div>

    <!-- Sign Out -->
    <div class="settings-card blur-fade" style="--delay: 2">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <div style="font-size: 14px; font-weight: 500;">Sign out of all devices</div>
                <div style="font-size: 12px; color: var(--text-muted);">This will log you out everywhere</div>
            </div>
            <button class="danger-btn" onclick="signOutAll()">Sign Out All</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var settingsSupabase = window.supabase.createClient(
        '{{ SUPABASE_URL }}',
        '{{ SUPABASE_ANON_KEY }}'
    );

    // Load profile data
    (async function loadProfile() {
        try {
            var result = await settingsSupabase.auth.getUser();
            var user = result.data.user;
            if (!user) { window.location.href = '/login'; return; }

            document.getElementById('emailAddress').value = user.email || '';
            document.getElementById('profileEmail').textContent = user.email || '';

            // Try to load profile from profiles table
            var profileResult = await settingsSupabase
                .from('profiles')
                .select('username, timezone, currency, bio, notify_email, notify_whales, notify_marketing')
                .eq('id', user.id)
                .single();

            var profile = profileResult.data;
            if (profile) {
                document.getElementById('displayName').value = profile.username || '';
                document.getElementById('profileName').textContent = profile.username || user.email.split('@')[0];
                document.getElementById('avatarInitial').textContent = (profile.username || user.email)[0].toUpperCase();

                if (profile.timezone) document.getElementById('timezone').value = profile.timezone;
                if (profile.bio) document.getElementById('tradingBio').value = profile.bio;
            } else {
                var name = user.user_metadata?.username || user.email.split('@')[0];
                document.getElementById('displayName').value = name;
                document.getElementById('profileName').textContent = name;
                document.getElementById('avatarInitial').textContent = name[0].toUpperCase();
            }
        } catch(e) {
            console.error('Failed to load profile:', e);
        }
    })();

    window.saveProfile = async function() {
        var btn = document.getElementById('saveProfileBtn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            var result = await settingsSupabase.auth.getUser();
            var user = result.data.user;
            if (!user) return;

            var updates = {
                id: user.id,
                username: document.getElementById('displayName').value,
                timezone: document.getElementById('timezone').value,
                bio: document.getElementById('tradingBio').value,
                updated_at: new Date().toISOString()
            };

            var upsertResult = await settingsSupabase
                .from('profiles')
                .upsert(updates, { onConflict: 'id' });

            if (upsertResult.error) {
                showSettingsMessage(upsertResult.error.message, 'error');
            } else {
                showSettingsMessage('Profile saved successfully!', 'success');
                document.getElementById('profileName').textContent = updates.username;
                document.getElementById('avatarInitial').textContent = (updates.username || '?')[0].toUpperCase();
            }
        } catch(e) {
            showSettingsMessage('Error: ' + e.message, 'error');
        }

        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes';
    };

    window.signOutAll = async function() {
        if (!confirm('Are you sure you want to sign out of all devices?')) return;
        await settingsSupabase.auth.signOut({ scope: 'global' });
        window.location.href = '/login';
    };

    window.showSettingsMessage = function(text, type) {
        var el = document.getElementById('settingsMessage');
        el.textContent = text;
        el.className = 'settings-message ' + type;
        setTimeout(function() {
            el.className = 'settings-message';
        }, 5000);
    };
});
</script>
{% endblock %}
