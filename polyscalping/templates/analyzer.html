{% extends "base.html" %}
{% block title %}Event Analyzer - PolyScalping{% endblock %}

{% block extra_styles %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    .analyzer-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
    }
    @media (max-width: 1000px) {
        .analyzer-layout { grid-template-columns: 1fr; }
    }
    .sidebar { display: flex; flex-direction: column; gap: 20px; }
    .card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius);
        padding: 20px;
    }
    .card.animated-border-box {
        border: none;
        padding: 0;
    }
    .card.animated-border-box .card-inner {
        padding: 20px;
        position: relative;
        z-index: 2;
    }
    .card-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .card-title .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--accent-blue);
    }
    .budget-presets {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 12px;
    }
    .preset {
        padding: 6px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 16px;
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .preset:hover, .preset.active {
        background: rgba(59,165,181,0.15);
        border-color: var(--accent-blue);
        color: var(--accent-cyan);
    }
    .results { display: flex; flex-direction: column; gap: 20px; }

    /* Progress Section */
    .progress-section {
        background: linear-gradient(135deg, var(--bg-card) 0%, rgba(59,165,181,0.05) 100%);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius);
        padding: 24px;
    }
    .progress-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .progress-bar-wrap {
        background: var(--bg-secondary);
        border-radius: 8px;
        height: 8px;
        overflow: hidden;
        margin-bottom: 12px;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3ba5b5, #0dd3ce);
        border-radius: 8px;
        transition: width 0.3s ease;
    }
    .progress-steps {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }
    .progress-step {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--text-muted);
        padding: 6px 0;
    }
    .progress-step.active {
        color: var(--accent-blue);
    }
    .progress-step.done {
        color: var(--accent-green);
    }
    .step-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
    }
    .progress-step.active .step-icon {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }
    .progress-step.done .step-icon {
        background: var(--accent-green);
        border-color: var(--accent-green);
        color: white;
    }

    /* Decision Box */
    .decision-box {
        background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(59,165,181,0.1) 100%);
        border: 2px solid var(--accent-green);
        border-radius: 16px;
        padding: 24px;
        position: relative;
    }
    .decision-box.negative {
        background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(245,158,11,0.1) 100%);
        border-color: var(--accent-red);
    }
    .decision-box.neutral {
        background: linear-gradient(135deg, rgba(100,100,100,0.1) 0%, rgba(150,150,150,0.1) 100%);
        border-color: #666;
    }
    .badge {
        position: absolute;
        top: 16px;
        right: 16px;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .badge.buy { background: var(--accent-green); color: #000; }
    .badge.avoid { background: var(--accent-red); color: #fff; }
    .badge.hold { background: #666; color: #fff; }
    .decision-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .decision-sub { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
    .action-row {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
    }
    .action-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
    }
    .action-icon.buy { background: var(--accent-green); }
    .action-icon.sell { background: var(--accent-red); }
    .action-text { flex: 1; }
    .action-main { font-size: 15px; font-weight: 600; }
    .action-detail { font-size: 12px; color: var(--text-secondary); }
    .action-amount { text-align: right; }
    .action-value { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; }
    .action-label { font-size: 11px; color: var(--text-muted); }

    /* Event Info */
    .event-info {
        display: flex;
        gap: 16px;
        align-items: center;
    }
    .event-img {
        width: 70px;
        height: 70px;
        border-radius: 10px;
        object-fit: cover;
        background: var(--bg-secondary);
    }
    .event-title { font-size: 17px; font-weight: 600; margin-bottom: 6px; }
    .event-meta { font-size: 13px; color: var(--text-secondary); }

    /* Metrics Row */
    .metrics {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }
    @media (max-width: 800px) {
        .metrics { grid-template-columns: repeat(2, 1fr); }
    }
    .metric {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius);
        padding: 14px;
        text-align: center;
    }
    .metric-val { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 700; }
    .metric-lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }

    /* Charts */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    @media (max-width: 900px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
    .chart-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius);
        padding: 16px;
    }
    .chart-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .chart-wrap {
        height: 200px;
        position: relative;
    }

    /* Data Table */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    .data-table th, .data-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-subtle);
    }
    .data-table th {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
    }
    .data-table tr:hover td {
        background: var(--bg-card-hover);
    }
    .data-table .badge-inline {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .badge-green { background: rgba(16,185,129,0.2); color: var(--accent-green); }
    .badge-red { background: rgba(239,68,68,0.2); color: var(--accent-red); }
    .badge-yellow { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
    .badge-purple { background: rgba(59,165,181,0.2); color: var(--accent-teal); }
    .badge-blue { background: rgba(59,165,181,0.2); color: var(--accent-blue); }

    /* Whale Section */
    .whale-flow {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 16px;
    }
    .whale-flow-icon {
        font-size: 24px;
    }
    .whale-flow-text {
        flex: 1;
    }
    .whale-flow-direction {
        font-weight: 700;
        font-size: 15px;
    }
    .whale-flow-stats {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* AI Report */
    .ai-report {
        background: linear-gradient(135deg, var(--bg-card) 0%, rgba(59,165,181,0.05) 100%);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius);
        padding: 20px;
    }
    .ai-report-content {
        font-size: 14px;
        line-height: 1.7;
        color: var(--text-secondary);
    }
    .ai-report-content h1, .ai-report-content h2, .ai-report-content h3 {
        color: var(--text-primary);
        margin-top: 20px;
        margin-bottom: 10px;
    }
    .ai-report-content h1 { font-size: 18px; }
    .ai-report-content h2 { font-size: 16px; }
    .ai-report-content h3 { font-size: 14px; }
    .ai-report-content ul, .ai-report-content ol {
        margin-left: 20px;
        margin-bottom: 12px;
    }
    .ai-report-content strong {
        color: var(--text-primary);
    }
    .ai-report-content code {
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
    }

    /* Quick Events */
    .quick-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
        transition: all 0.2s;
    }
    .quick-item:hover { background: var(--bg-secondary); margin: 0 -20px; padding: 10px 20px; }
    .quick-item:last-child { border-bottom: none; }
    .quick-img { width: 36px; height: 36px; border-radius: 6px; object-fit: cover; background: var(--bg-secondary); }
    .quick-info { flex: 1; min-width: 0; }
    .quick-title { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .quick-score { font-size: 11px; color: var(--text-muted); }

    .empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

    /* Mascot Preloader */
    .atom-loader-wrap {
        position: relative;
        width: 480px;
        height: 480px;
        margin: 0 auto 24px;
    }
    .atom-loader-img {
        width: 480px;
        height: 480px;
        object-fit: contain;
    }
    @media (max-width: 600px) {
        .atom-loader-wrap, .atom-loader-img {
            width: 260px;
            height: 260px;
        }
    }

    /* Progress mascot (smaller version for analysis) */
    .atom-progress-wrap {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 20px;
    }
    .atom-progress-img {
        width: 120px;
        height: 120px;
        object-fit: contain;
    }

    /* Loading text animation */
    .loading-text {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        animation: textFade 2s ease-in-out infinite;
    }
    .loading-subtext {
        font-size: 15px;
        color: var(--text-muted);
        margin-top: 10px;
    }
    @keyframes textFade {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }

    /* Tabs */
    .result-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 20px;
        background: var(--bg-secondary);
        padding: 4px;
        border-radius: 8px;
    }
    .result-tab {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
        background: transparent;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .result-tab:hover {
        color: var(--text-primary);
    }
    .result-tab.active {
        background: var(--bg-card);
        color: var(--text-primary);
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

    /* Mobile responsive */
    @media (max-width: 600px) {
        .sidebar {
            gap: 16px;
        }

        .card, .card.animated-border-box .card-inner {
            padding: 16px;
        }

        .decision-box {
            padding: 16px;
        }

        .decision-title {
            font-size: 18px;
            padding-right: 60px;
        }

        .badge {
            font-size: 11px;
            padding: 4px 12px;
        }

        .action-row {
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }

        .action-amount {
            text-align: center;
        }

        .event-info {
            flex-direction: column;
            text-align: center;
        }

        .metrics {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .metric {
            padding: 12px 8px;
        }

        .metric-val {
            font-size: 16px;
        }

        .result-tabs {
            flex-wrap: wrap;
        }

        .result-tab {
            flex: 1;
            min-width: calc(50% - 4px);
            text-align: center;
            font-size: 12px;
            padding: 8px 10px;
        }

        .progress-section {
            padding: 16px;
        }

        .chart-card {
            padding: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header blur-fade" style="--delay: 0;">
    <h1 class="page-title">Event Analyzer</h1>
    <p class="page-subtitle">Comprehensive analysis with Kelly sizing, whale tracking, and AI insights</p>
</div>

<div class="analyzer-layout">
    <div class="sidebar">
        <div class="card animated-border-box blur-fade" style="--delay: 1;">
            <div class="card-inner">
                <div class="card-title"><span class="dot"></span>Trading Budget</div>
                <input type="number" class="input" id="budget" value="1000" style="width:100%;">
                <div class="budget-presets">
                    <button class="preset" onclick="setBudget(500)">$500</button>
                    <button class="preset active" onclick="setBudget(1000)">$1K</button>
                    <button class="preset" onclick="setBudget(2500)">$2.5K</button>
                    <button class="preset" onclick="setBudget(5000)">$5K</button>
                </div>
            </div>
        </div>

        <div class="card animated-border-box blur-fade" style="--delay: 2;">
            <div class="card-inner">
                <div class="card-title"><span class="dot" style="background:var(--accent-purple)"></span>Analyze Event</div>
                <input type="text" class="input" id="eventUrl" placeholder="Paste Polymarket event URL..." style="width:100%; margin-bottom:12px;">
                <button class="btn btn-gradient-animated" onclick="analyze()" id="analyzeBtn" style="width:100%;">
                    <span id="analyzeBtnText">‚ú® Run Full Analysis</span>
                </button>
            </div>
        </div>

        <div class="card blur-fade" style="--delay: 3;">
            <div class="card-title"><span class="dot" style="background:var(--accent-yellow)"></span>Hot Events</div>
            <div id="hotEvents"><div class="loading"><div class="spinner"></div></div></div>
        </div>
    </div>

    <div class="results blur-fade" style="--delay: 4;" id="results">
        <div class="empty">
            <div class="atom-loader-wrap">
                <img src="{{ url_for('static', filename='images/atom-loader.png') }}" class="atom-loader-img" alt="AI Analyzer">
            </div>
            <p class="loading-text">No event selected</p>
            <small class="loading-subtext">Paste an event URL or click a hot event to start comprehensive analysis</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let budget = 1000;
let currentJobId = null;
let pollRetries = 0;
let pollInterval = null;
let chartInstances = {};

const PIPELINE_STEPS = [
    "Fetching Polymarket event data...",
    "Fetching stock/asset data...",
    "Running probability models...",
    "Fetching sports odds (if applicable)...",
    "Searching Kalshi for cross-platform opportunities...",
    "Tracking whale wallets on Polygon...",
    "Fetching CLOB orderbook depth...",
    "Calculating Kelly sizing & strategy...",
    "Generating AI analysis report...",
    "Finalizing results..."
];

function setBudget(val) {
    budget = val;
    document.getElementById('budget').value = val;
    document.querySelectorAll('.preset').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
}

document.getElementById('budget').addEventListener('input', e => {
    budget = parseFloat(e.target.value) || 1000;
});

function destroyCharts() {
    Object.values(chartInstances).forEach(c => c.destroy());
    chartInstances = {};
}

async function analyze() {
    let url = document.getElementById('eventUrl').value.trim();
    let slug = url;

    if (url.includes('polymarket.com')) {
        const m = url.match(/event\/([^\/\?]+)/);
        if (m) slug = m[1];
    }

    if (!slug) return alert('Enter an event URL');

    destroyCharts();
    showProgress();

    try {
        const res = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({slug, budget})
        });
        const data = await res.json();

        if (data.error) {
            document.getElementById('results').innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>${data.error}</p></div>`;
            return;
        }

        currentJobId = data.job_id;
        pollStatus();
    } catch(e) {
        console.error(e);
        document.getElementById('results').innerHTML = '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>Failed to start analysis</p></div>';
    }
}

function showProgress() {
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('analyzeBtnText').textContent = 'Analyzing...';

    let stepsHtml = PIPELINE_STEPS.map((step, i) => `
        <div class="progress-step" id="step-${i}">
            <div class="step-icon" id="step-icon-${i}">${i + 1}</div>
            <span>${step}</span>
        </div>
    `).join('');

    document.getElementById('results').innerHTML = `
        <div class="progress-section">
            <div class="atom-progress-wrap">
                <img src="/static/images/atom-loader.png" class="atom-progress-img" alt="Analyzing">
            </div>
            <div class="progress-title" style="justify-content:center">
                Running Comprehensive Analysis...
            </div>
            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
            </div>
            <div class="progress-steps">${stepsHtml}</div>
        </div>
    `;
}

function updateProgress(step, totalSteps, label) {
    const pct = (step / totalSteps) * 100;
    const fill = document.getElementById('progress-fill');
    if (fill) fill.style.width = pct + '%';

    for (let i = 0; i < totalSteps; i++) {
        const stepEl = document.getElementById('step-' + i);
        const iconEl = document.getElementById('step-icon-' + i);
        if (!stepEl) continue;

        if (i < step - 1) {
            stepEl.className = 'progress-step done';
            iconEl.innerHTML = '‚úì';
        } else if (i === step - 1) {
            stepEl.className = 'progress-step active';
            iconEl.innerHTML = '‚ñ∂';
        } else {
            stepEl.className = 'progress-step';
            iconEl.innerHTML = (i + 1);
        }
    }
}

async function pollStatus() {
    if (!currentJobId) return;

    try {
        const res = await fetch('/api/analyze/status/' + currentJobId);
        const st = await res.json();

        // Handle job not found (404) or missing status fields
        if (res.status === 404 || st.error === 'Job not found') {
            pollRetries = (pollRetries || 0) + 1;
            if (pollRetries > 5) {
                document.getElementById('results').innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>Analysis job lost. Please try again.</p></div>`;
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtnText').textContent = 'Run Full Analysis';
                return;
            }
            setTimeout(pollStatus, 1500);
            return;
        }
        pollRetries = 0;

        updateProgress(st.step || 0, st.total_steps || 10, st.step_label || 'Processing...');

        if (st.status === 'completed') {
            const result = await fetch('/api/analyze/result/' + currentJobId).then(r => r.json());
            renderFullResults(result);
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('analyzeBtnText').textContent = 'Run Full Analysis';
        } else if (st.status === 'error') {
            document.getElementById('results').innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>Error: ${st.error}</p></div>`;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('analyzeBtnText').textContent = 'Run Full Analysis';
        } else {
            setTimeout(pollStatus, 500);
        }
    } catch(e) {
        console.error(e);
        setTimeout(pollStatus, 1000);
    }
}

function renderFullResults(data) {
    const ev = data.event || {};
    const strat = data.strategy || {};
    const strikes = data.strike_analysis || [];
    const whale = data.whale_tracking || {};
    const kalshi = data.kalshi_comparison || {};
    const orderbook = data.orderbook_depth || {};
    const report = data.claude_report || '';

    // ============================================================
    // USE BACKEND STRATEGY for all key metrics (not frontend guessing)
    // The backend has the composite scoring algorithm
    // ============================================================
    const bestSide = strat.best_side || 'YES';
    const bestMarketQuestion = strat.best_market || '';

    // Find the matching strike from backend strategy
    let bestMarket = strikes[0] || {};
    for (const s of strikes) {
        if (s.question === bestMarketQuestion) {
            bestMarket = s;
            break;
        }
    }

    // Get kelly data for the strategy's chosen side
    const kellyData = (bestMarket.kelly || {})[bestSide] || {};

    // ALL metrics come from backend strategy or matching kelly data
    const entryPrice = strat.entry_price || kellyData.price || 0;
    const roiIfWin = strat.roi_if_win || kellyData.roi_if_win || 0;
    let posSize = strat.recommended_position || 0;
    if (posSize <= 0) posSize = Math.round(budget * 0.10);
    const posPct = strat.position_pct || (posSize / budget * 100);
    const riskReward = strat.risk_reward || 0;
    const confidence = strat.confidence || kellyData.confidence || 'low';

    // Win probability ‚âà entry price for the chosen side
    const winProb = entryPrice || 0.5;
    const expectedProfit = posSize * (roiIfWin / 100) * winProb;

    // Decision logic based on strategy data
    let rec = 'BUY', cls = '', icon = 'üöÄ', txt = '', sub = '';

    if (confidence === 'high' && winProb >= 0.65) {
        rec = 'STRONG BUY'; cls = ''; icon = 'üî•';
        txt = `High-conviction ¬∑ ${(winProb * 100).toFixed(0)}% win probability`;
        sub = `$${posSize.toFixed(0)} position ¬∑ ${roiIfWin.toFixed(0)}% ROI ¬∑ ~$${expectedProfit.toFixed(0)} expected profit`;
    } else if ((confidence === 'medium' || confidence === 'high') && winProb >= 0.40) {
        rec = 'BUY'; cls = ''; icon = 'üöÄ';
        txt = `Good opportunity ¬∑ ${(winProb * 100).toFixed(0)}% win probability`;
        sub = `$${posSize.toFixed(0)} position ¬∑ ${roiIfWin.toFixed(0)}% ROI ¬∑ ~$${expectedProfit.toFixed(0)} expected profit`;
    } else if (winProb >= 0.10) {
        rec = 'BUY'; cls = ''; icon = 'üí∞';
        txt = `Moderate play ¬∑ ${(winProb * 100).toFixed(0)}% win probability`;
        sub = `$${posSize.toFixed(0)} position ¬∑ ${roiIfWin.toFixed(0)}% ROI if correct`;
    } else {
        rec = 'SPECULATE'; cls = ''; icon = 'üéØ';
        txt = `Longshot ¬∑ ${(winProb * 100).toFixed(1)}% chance`;
        sub = `$${posSize.toFixed(0)} position ¬∑ ${roiIfWin.toFixed(0)}% ROI if correct`;
    }

    // Specific market name for multi-choice events
    const isMultiMarket = strat.is_multi_choice || strikes.length > 1;
    const bestMarketShort = strat.best_market_short || '';
    const bestMarketFull = strat.best_market || bestMarket.question || '';
    let targetName = '';
    if (isMultiMarket && bestMarketShort) {
        targetName = bestMarketShort;
    } else if (isMultiMarket && bestMarketFull) {
        targetName = bestMarketFull.length > 50 ? bestMarketFull.substring(0, 47) + '...' : bestMarketFull;
    }

    // Whale summary
    const whaleSummary = whale.summary || {};
    const netFlow = whaleSummary.net_flow || 0;
    const flowDirection = whale.net_flow_direction || 'Unknown';
    const flowColor = flowDirection.includes('INFLOW') ? 'var(--accent-green)' : 'var(--accent-red)';

    document.getElementById('results').innerHTML = `
        <!-- Decision Box -->
        <div class="decision-box ${cls}">
            <span class="badge ${rec.toLowerCase().replace(' ', '-')}">${rec}</span>
            <div class="decision-title">${icon} ${txt}</div>
            <div class="decision-sub">${sub}</div>
            <div class="action-row">
                <div class="action-icon buy">üí∞</div>
                <div class="action-text">
                    <div class="action-main" style="font-size:1.1rem">Buy ${bestSide}${targetName ? ' on <span style="color:var(--accent-cyan);font-weight:700">' + targetName + '</span>' : ''} at ${(entryPrice * 100).toFixed(1)}¬¢</div>
                    <div class="action-detail">${posPct.toFixed(1)}% of $${budget.toLocaleString()} bankroll ¬∑ R:R ${riskReward.toFixed(1)}x ¬∑ ${roiIfWin.toFixed(0)}% ROI if correct</div>
                </div>
                <div class="action-amount">
                    <div class="action-value" style="color:var(--accent-green)">$${posSize.toFixed(0)}</div>
                    <div class="action-label">Position Size</div>
                </div>
            </div>
        </div>

        <!-- Event Info -->
        <div class="card">
            <div class="event-info">
                ${ev.image ? '<img src="' + ev.image + '" class="event-img" onerror="this.style.display=\'none\'">' : ''}
                <div>
                    <div class="event-title">${ev.event_title || 'Unknown'}</div>
                    <div class="event-meta">Volume: ${formatUSD(ev.event_volume || 0)} ¬∑ Liquidity: ${formatUSD(ev.event_liquidity || 0)} ¬∑ ${data.days_to_expiry ? data.days_to_expiry.toFixed(1) + ' days left' : ''}</div>
                </div>
            </div>
        </div>

        <!-- Metrics ‚Äî all from backend strategy -->
        <div class="metrics">
            <div class="metric">
                <div class="metric-val text-green">+${roiIfWin.toFixed(0)}%</div>
                <div class="metric-lbl">ROI if Correct</div>
            </div>
            <div class="metric">
                <div class="metric-val text-blue">${posPct.toFixed(0)}%</div>
                <div class="metric-lbl">Position Size</div>
            </div>
            <div class="metric">
                <div class="metric-val text-cyan">${(entryPrice * 100).toFixed(1)}¬¢</div>
                <div class="metric-lbl">Entry Price</div>
            </div>
            <div class="metric">
                <div class="metric-val text-yellow">${riskReward > 0 ? riskReward.toFixed(1) + 'x' : 'N/A'}</div>
                <div class="metric-lbl">Risk/Reward</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="result-tabs">
            <button class="result-tab active" onclick="switchTab('charts')">Charts</button>
            <button class="result-tab" onclick="switchTab('markets')">Markets</button>
            <button class="result-tab" onclick="switchTab('whales')">Whales</button>
            <button class="result-tab" onclick="switchTab('orderbook')">Orderbook</button>
            <button class="result-tab" onclick="switchTab('ai')">AI Report</button>
        </div>

        <!-- Charts Tab -->
        <div class="tab-content active" id="tab-charts">
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">üìä Probability Comparison</div>
                    <div class="chart-wrap"><canvas id="chart-prob"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">üìà ROI Potential by Market</div>
                    <div class="chart-wrap"><canvas id="chart-roi"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">üíß Volume & Liquidity</div>
                    <div class="chart-wrap"><canvas id="chart-volume"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">üìè Position Sizing (% of Bankroll)</div>
                    <div class="chart-wrap"><canvas id="chart-kelly"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Markets Tab -->
        <div class="tab-content" id="tab-markets">
            <div class="card">
                <div class="card-title"><span class="dot"></span>Strike Analysis</div>
                <div style="overflow-x:auto">
                    <table class="data-table" id="strike-table"></table>
                </div>
            </div>
        </div>

        <!-- Whales Tab -->
        <div class="tab-content" id="tab-whales">
            <div class="card">
                <div class="card-title"><span class="dot" style="background:var(--accent-purple)"></span>Whale Activity</div>
                <div class="whale-flow">
                    <div class="whale-flow-icon">${flowDirection.includes('INFLOW') ? 'üìà' : 'üìâ'}</div>
                    <div class="whale-flow-text">
                        <div class="whale-flow-direction" style="color:${flowColor}">${flowDirection}</div>
                        <div class="whale-flow-stats">${whaleSummary.whale_count || 0} whales ¬∑ Net: ${formatUSD(netFlow)}</div>
                    </div>
                </div>
                <div style="overflow-x:auto">
                    <table class="data-table" id="whale-table"></table>
                </div>
            </div>
        </div>

        <!-- Orderbook Tab -->
        <div class="tab-content" id="tab-orderbook">
            <div class="card">
                <div class="card-title"><span class="dot" style="background:var(--accent-cyan)"></span>Orderbook Depth</div>
                <div style="overflow-x:auto">
                    <table class="data-table" id="orderbook-table"></table>
                </div>
            </div>
        </div>

        <!-- AI Report Tab -->
        <div class="tab-content" id="tab-ai">
            <div class="ai-report">
                <div class="card-title"><span class="dot" style="background:var(--accent-purple)"></span>Claude AI Analysis</div>
                <div class="ai-report-content" id="ai-report-content"></div>
            </div>
        </div>
    `;

    // Render charts
    setTimeout(() => renderCharts(data), 100);

    // Render tables
    renderStrikeTable(strikes, strat.best_market || '', strat.best_side || 'YES');
    renderWhaleTable(whale.whale_wallets || []);
    renderOrderbookTable(orderbook);

    // Render AI report
    if (report) {
        document.getElementById('ai-report-content').innerHTML = marked.parse(report);
    } else {
        document.getElementById('ai-report-content').innerHTML = '<p style="color:var(--text-muted)">AI report not available</p>';
    }
}

function switchTab(tab) {
    document.querySelectorAll('.result-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    document.querySelector('[onclick="switchTab(\'' + tab + '\')"]').classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
}

function renderCharts(data) {
    const strikes = data.strike_analysis || [];
    if (!strikes.length) return;

    const labels = strikes.map(s => s.strike > 0 ? '$' + s.strike : (s.question || '').substring(0, 15));
    const gridColor = 'rgba(30,39,54,0.6)';

    Chart.defaults.color = '#505b6e';
    Chart.defaults.borderColor = '#1e2736';

    // Probability Chart
    const ctx1 = document.getElementById('chart-prob');
    if (ctx1) {
        chartInstances.prob = new Chart(ctx1, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Market Price',
                        data: strikes.map(s => ((s.polymarket || {}).yes_price || 0) * 100),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59,130,246,0.1)',
                        fill: true,
                        tension: 0.4,
                    },
                    {
                        label: 'True Probability',
                        data: strikes.map(s => ((s.black_scholes || {}).true_probability || 0) * 100),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.1)',
                        fill: true,
                        tension: 0.4,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: gridColor }, ticks: { callback: v => v + '%' } },
                    x: { grid: { color: gridColor } }
                }
            }
        });
    }

    // ROI Chart
    const ctx2 = document.getElementById('chart-roi');
    if (ctx2) {
        chartInstances.roi = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'ROI if YES',
                        data: strikes.map(s => ((s.roi_yes_wins || {}).roi_percent || 0)),
                        backgroundColor: 'rgba(16,185,129,0.6)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                    },
                    {
                        label: 'ROI if NO',
                        data: strikes.map(s => ((s.roi_no_wins || {}).roi_percent || 0)),
                        backgroundColor: 'rgba(139,92,246,0.6)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: gridColor }, ticks: { callback: v => v + '%' } },
                    x: { grid: { color: gridColor } }
                }
            }
        });
    }

    // Volume Chart
    const ctx3 = document.getElementById('chart-volume');
    if (ctx3) {
        chartInstances.volume = new Chart(ctx3, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Volume',
                        data: strikes.map(s => (s.polymarket || {}).volume || 0),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139,92,246,0.1)',
                        fill: true,
                    },
                    {
                        label: 'Liquidity',
                        data: strikes.map(s => (s.polymarket || {}).liquidity || 0),
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6,182,212,0.1)',
                        fill: true,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: gridColor }, ticks: { callback: v => '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'k' : v) } },
                    x: { grid: { color: gridColor } }
                }
            }
        });
    }

    // Kelly Chart
    const ctx4 = document.getElementById('chart-kelly');
    if (ctx4) {
        chartInstances.kelly = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'YES Position %',
                        data: strikes.map(s => ((s.kelly || {}).YES || {}).aggressive_kelly_pct || 0),
                        backgroundColor: 'rgba(16,185,129,0.6)',
                    },
                    {
                        label: 'NO Position %',
                        data: strikes.map(s => ((s.kelly || {}).NO || {}).aggressive_kelly_pct || 0),
                        backgroundColor: 'rgba(239,68,68,0.6)',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { grid: { color: gridColor }, ticks: { callback: v => v + '%' } },
                    x: { grid: { color: gridColor } }
                }
            }
        });
    }
}

function renderStrikeTable(strikes, strategyMarket, strategySide) {
    if (!strikes.length) {
        document.getElementById('strike-table').innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted)">No markets</td></tr>';
        return;
    }

    let html = `<thead><tr>
        <th>Market</th><th>YES Price</th><th>Best Side</th><th>Position</th><th>ROI if Win</th><th>Win Prob</th><th>Expected $</th>
    </tr></thead><tbody>`;

    for (const s of strikes) {
        const kelly = s.kelly || {};
        const label = s.strike > 0 ? '$' + s.strike : (s.question || '').substring(0, 35);
        const yesPrice = (s.polymarket || {}).yes_price || 0;

        // Pick the better side for this market (higher position)
        const kYes = kelly.YES || {};
        const kNo = kelly.NO || {};
        const bestSideK = kYes.bet_amount >= kNo.bet_amount ? kYes : kNo;
        const bestSideName = kYes.bet_amount >= kNo.bet_amount ? 'YES' : 'NO';
        const winP = bestSideK.price || 0.5;
        const roi = bestSideK.roi_if_win || 0;
        const bet = bestSideK.bet_amount || 0;
        const expectedDollar = bet * (roi / 100) * winP;

        // Highlight the strategy's recommended market
        const isStratPick = s.question === strategyMarket;
        const rowStyle = isStratPick ? 'background:rgba(16,185,129,0.1);border-left:3px solid var(--accent-green)' : '';

        html += `<tr style="${rowStyle}">
            <td><strong>${isStratPick ? '‚≠ê ' : ''}${label}</strong></td>
            <td>${(yesPrice * 100).toFixed(1)}¬¢</td>
            <td><span class="badge-inline ${bestSideName === 'YES' ? 'badge-green' : 'badge-red'}">${bestSideName}</span></td>
            <td><strong>$${bet.toFixed(0)}</strong> <span style="color:var(--text-muted);font-size:0.8em">(${(bestSideK.position_pct || 0).toFixed(0)}%)</span></td>
            <td style="color:var(--accent-green)">${roi.toFixed(0)}%</td>
            <td>${(winP * 100).toFixed(0)}%</td>
            <td style="color:var(--accent-yellow)">~$${expectedDollar.toFixed(0)}</td>
        </tr>`;
    }

    html += '</tbody>';
    document.getElementById('strike-table').innerHTML = html;
}

function renderWhaleTable(wallets) {
    if (!wallets.length) {
        document.getElementById('whale-table').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No whale data</td></tr>';
        return;
    }

    let html = `<thead><tr>
        <th>Wallet</th><th>Volume</th><th>Txs</th><th>Max Tx</th><th>Direction</th><th>Tag</th>
    </tr></thead><tbody>`;

    for (const w of wallets.slice(0, 10)) {
        const short = w.address.slice(0, 8) + '...' + w.address.slice(-4);
        const tagClass = w.is_whale ? 'badge-purple' : 'badge-blue';
        const dirClass = w.net_direction === 'NET BUYER' ? 'text-green' : 'text-red';

        html += `<tr>
            <td title="${w.address}">${short}</td>
            <td>${formatUSD(w.total_volume_usd)}</td>
            <td>${w.tx_count}</td>
            <td>${formatUSD(w.max_single_tx_usd)}</td>
            <td class="${dirClass}">${w.net_direction}</td>
            <td><span class="badge-inline ${tagClass}">${w.whale_tag}</span></td>
        </tr>`;
    }

    html += '</tbody>';
    document.getElementById('whale-table').innerHTML = html;
}

function renderOrderbookTable(orderbook) {
    const keys = Object.keys(orderbook);
    if (!keys.length) {
        document.getElementById('orderbook-table').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No orderbook data</td></tr>';
        return;
    }

    let html = `<thead><tr>
        <th>Market</th><th>YES Bid</th><th>YES Ask</th><th>Bid Depth</th><th>Ask Depth</th><th>Spread</th>
    </tr></thead><tbody>`;

    for (const key of keys) {
        const book = orderbook[key];
        const yes = book.yes || {};
        const bestBid = yes.best_bid || 0;
        const bestAsk = yes.best_ask || 0;
        const spread = bestAsk > 0 ? ((bestAsk - bestBid) * 100).toFixed(1) : 'N/A';

        html += `<tr>
            <td><strong>${key}</strong></td>
            <td>${(bestBid * 100).toFixed(1)}%</td>
            <td>${(bestAsk * 100).toFixed(1)}%</td>
            <td>${formatUSD(yes.bid_depth_usd)}</td>
            <td>${formatUSD(yes.ask_depth_usd)}</td>
            <td>${spread}%</td>
        </tr>`;
    }

    html += '</tbody>';
    document.getElementById('orderbook-table').innerHTML = html;
}

async function loadHot() {
    try {
        // AGGRESSIVE: Lower minimum score to show more opportunities (was 30)
        const res = await fetch('/api/trending?limit=8&min_score=15');
        const data = await res.json();
        const c = document.getElementById('hotEvents');

        if (!data.markets?.length) {
            c.innerHTML = '<div style="color:var(--text-muted);padding:20px;text-align:center">No events</div>';
            return;
        }

        c.innerHTML = data.markets.map(m => `
            <div class="quick-item" onclick="quickAnalyze('${m.event_slug}')">
                ${m.event_image ? '<img src="' + m.event_image + '" class="quick-img">' : '<div class="quick-img"></div>'}
                <div class="quick-info">
                    <div class="quick-title">${m.question}</div>
                    <div class="quick-score">Score: ${m.polysnap_score}</div>
                </div>
            </div>
        `).join('');
    } catch(e) {
        document.getElementById('hotEvents').innerHTML = '<div style="color:var(--text-muted);padding:20px">Failed to load</div>';
    }
}

function quickAnalyze(slug) {
    document.getElementById('eventUrl').value = slug;
    analyze();
}

document.getElementById('eventUrl').addEventListener('keypress', e => {
    if (e.key === 'Enter') analyze();
});

loadHot();
</script>
{% endblock %}
