{% extends "base.html" %}
{% block title %}Markets - PolyScalping{% endblock %}

{% block extra_styles %}
<style>
    /* Top Filter Bar */
    .top-filters {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-select {
        padding: 8px 12px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        outline: none;
    }

    .filter-select:focus {
        border-color: var(--accent-blue);
    }

    .filter-label {
        font-size: 13px;
        color: var(--text-secondary);
    }

    .sort-tabs {
        display: flex;
        gap: 0;
    }

    .sort-tab {
        padding: 8px 16px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .sort-tab:first-child { border-radius: 6px 0 0 6px; }
    .sort-tab:last-child { border-radius: 0 6px 6px 0; }
    .sort-tab:not(:last-child) { border-right: none; }

    .sort-tab.active {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: white;
    }

    .actions-group {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    .action-btn {
        padding: 8px 14px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .action-btn:hover {
        border-color: var(--accent-blue);
        color: var(--text-primary);
    }

    /* Advanced Filters Panel */
    .filters-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-bottom: 16px;
    }

    @media (max-width: 1200px) {
        .filters-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
        .filters-grid { grid-template-columns: 1fr; }
    }

    .filter-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px 16px;
        position: relative;
    }

    .filter-card.purple-border { border-color: var(--accent-purple); }
    .filter-card.blue-border { border-color: var(--accent-blue); }
    .filter-card.yellow-border { border-color: var(--accent-yellow); }
    .filter-card.green-border { border-color: var(--accent-green); }

    .filter-card-header {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
        position: relative;
    }

    .filter-card-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: center;
    }

    .filter-card-title .icon {
        font-size: 14px;
    }

    .filter-card-title.purple { color: var(--accent-purple); }
    .filter-card-title.blue { color: var(--accent-blue); }
    .filter-card-title.green { color: var(--accent-green); }
    .filter-card-title.yellow { color: var(--accent-yellow); }

    .filter-info-btn {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-muted);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
    }

    .filter-range {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-range-input {
        flex: 1;
        padding: 10px 12px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 20px;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        text-align: center;
        outline: none;
        min-width: 0;
    }

    .filter-range-input:focus {
        border-color: var(--accent-blue);
    }

    .filter-range-sep {
        color: var(--text-muted);
        font-size: 14px;
        flex-shrink: 0;
        padding: 0 4px;
    }

    /* Time Filters Row */
    .time-filters-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 0;
    }

    @media (max-width: 1200px) {
        .time-filters-row { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
        .time-filters-row { grid-template-columns: 1fr; }
    }

    .time-filter-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px 16px;
    }

    .time-filter-card.red-border { border-color: var(--accent-red); }
    .time-filter-card.blue-border { border-color: var(--accent-blue); }
    .time-filter-card.pink-border { border-color: #ec4899; }
    .time-filter-card.orange-border { border-color: #f97316; }

    .time-filter-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .time-filter-title.red { color: var(--accent-red); }
    .time-filter-title.blue { color: var(--accent-blue); }
    .time-filter-title.pink { color: #ec4899; }
    .time-filter-title.orange { color: #f97316; }

    .time-filter-options {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .time-filter-btn {
        padding: 8px 16px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 20px;
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .time-filter-btn:hover {
        border-color: var(--text-muted);
        color: var(--text-primary);
    }

    .time-filter-btn.active.red {
        background: var(--accent-red);
        border-color: var(--accent-red);
        color: #fff;
    }
    .time-filter-btn.active.blue {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: #fff;
    }
    .time-filter-btn.active.pink {
        background: #ec4899;
        border-color: #ec4899;
        color: #fff;
    }
    .time-filter-btn.active.orange {
        background: #f97316;
        border-color: #f97316;
        color: #fff;
    }

    /* Markets Grid */
    .markets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 16px;
    }

    .market-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius);
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .market-card:hover {
        border-color: var(--accent-blue);
        transform: translateY(-2px);
    }

    .market-card-header {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }

    .market-card-image {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        object-fit: cover;
        background: var(--bg-secondary);
        flex-shrink: 0;
    }

    .market-card-info {
        flex: 1;
        min-width: 0;
    }

    .market-card-title {
        font-size: 14px;
        font-weight: 500;
        line-height: 1.4;
        margin-bottom: 6px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .market-card-badges {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .market-card-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-subtle);
    }

    .market-stat {
        text-align: center;
    }

    .market-stat-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 15px;
        font-weight: 600;
    }

    .market-stat-label {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-top: 2px;
    }

    .market-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-subtle);
    }

    .market-score {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .score-bar {
        width: 60px;
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
    }

    .score-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s;
    }

    .score-fill.hot { background: var(--accent-red); }
    .score-fill.warm { background: var(--accent-yellow); }
    .score-fill.cool { background: var(--accent-blue); }
    .score-fill.obvious { background: #64748b; }

    .market-change {
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        font-weight: 600;
    }

    .results-count {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 16px;
    }

    .category-badge {
        background: rgba(79,143,247,0.1);
        color: var(--accent-blue);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* Mobile responsive */
    @media (max-width: 900px) {
        .top-filters {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
        }

        .filter-group {
            width: 100%;
        }

        .sort-tabs {
            flex: 1;
        }

        .sort-tab {
            flex: 1;
            text-align: center;
        }

        .actions-group {
            margin-left: 0;
            justify-content: flex-end;
        }

        .time-filters-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .filters-panel {
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .filters-grid {
            gap: 6px;
            margin-bottom: 6px;
        }

        .filter-card {
            padding: 8px 10px;
            border-radius: 8px;
        }

        .filter-card-header {
            margin-bottom: 6px;
        }

        .filter-card-title {
            font-size: 9px;
            gap: 3px;
        }

        .filter-card-title .icon {
            font-size: 10px;
        }

        .filter-info-btn {
            width: 14px;
            height: 14px;
            font-size: 8px;
        }

        .filter-range {
            gap: 4px;
        }

        .filter-range-input {
            padding: 6px 8px;
            font-size: 10px;
            border-radius: 12px;
        }

        .filter-range-sep {
            font-size: 10px;
            padding: 0;
        }

        .time-filter-card {
            padding: 8px 10px;
            border-radius: 8px;
        }

        .time-filter-title {
            font-size: 9px;
            margin-bottom: 6px;
            gap: 3px;
        }

        .time-filters-row {
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .time-filter-options {
            gap: 3px;
        }

        .time-filter-btn {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 10px;
        }

        .markets-grid {
            grid-template-columns: 1fr;
        }

        .market-card-stats {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .market-stat-value {
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header blur-fade" style="--delay: 0;">
    <h1 class="page-title">Risky Opportunities</h1>
    <p class="page-subtitle">Find uncertain markets with high ROI potential - not obvious outcomes</p>
</div>

<!-- Top Filters -->
<div class="top-filters blur-fade" style="--delay: 1;">
    <div class="filter-group">
        <span class="filter-label">Category:</span>
        <select class="filter-select" id="filterCategory">
            <option value="all">All</option>
            <option value="crypto">Crypto</option>
            <option value="politics">Politics</option>
            <option value="stocks">Stocks</option>
            <option value="sports">Sports</option>
            <option value="other">Other</option>
        </select>
    </div>

    <div class="filter-group">
        <span class="filter-label">Sort:</span>
        <div class="sort-tabs">
            <button class="sort-tab active" data-sort="score">Risky</button>
            <button class="sort-tab" data-sort="volume">Volume</button>
            <button class="sort-tab" data-sort="liquidity">Liquidity</button>
        </div>
    </div>

    <div class="actions-group">
        <button class="action-btn">
            <span>&#9733;</span> Watchlist
        </button>
        <button class="action-btn" onclick="resetFilters()">
            <span>&#8634;</span> Reset Filters
        </button>
    </div>
</div>

<!-- Advanced Filters Panel -->
<div class="filters-panel blur-fade" style="--delay: 2;" id="filtersPanel">
    <!-- Range Filters -->
    <div class="filters-grid">
        <!-- 24H Volume -->
        <div class="filter-card purple-border">
            <div class="filter-card-header">
                <div class="filter-card-title purple">
                    <span class="icon">&#8599;</span> 24H Volume
                </div>
                <button class="filter-info-btn">&#9432;</button>
            </div>
            <div class="filter-range">
                <input type="text" class="filter-range-input" id="volumeMin" value="0" placeholder="0">
                <span class="filter-range-sep">&#8594;</span>
                <input type="text" class="filter-range-input" id="volumeMax" value="100 000 000" placeholder="100M">
            </div>
        </div>

        <!-- Liquidity -->
        <div class="filter-card blue-border">
            <div class="filter-card-header">
                <div class="filter-card-title blue">
                    <span class="icon">&#9889;</span> Liquidity
                </div>
                <button class="filter-info-btn">&#9432;</button>
            </div>
            <div class="filter-range">
                <input type="text" class="filter-range-input" id="liquidityMin" value="0" placeholder="0">
                <span class="filter-range-sep">&#8594;</span>
                <input type="text" class="filter-range-input" id="liquidityMax" value="100 000 000" placeholder="100M">
            </div>
        </div>

        <!-- Spread (%) -->
        <div class="filter-card yellow-border">
            <div class="filter-card-header">
                <div class="filter-card-title yellow">
                    <span class="icon">&#128202;</span> Spread (%)
                </div>
                <button class="filter-info-btn">&#9432;</button>
            </div>
            <div class="filter-range">
                <input type="text" class="filter-range-input" id="spreadMinPct" value="0" placeholder="0">
                <span class="filter-range-sep">&#8594;</span>
                <input type="text" class="filter-range-input" id="spreadMaxPct" value="100 000" placeholder="100K">
            </div>
        </div>

    </div>

    <!-- Time-based Filters -->
    <div class="time-filters-row">
        <!-- Time Remaining -->
        <div class="time-filter-card red-border">
            <div class="time-filter-title red">
                <span>&#9201;</span> Time Remaining
            </div>
            <div class="time-filter-options">
                <button class="time-filter-btn active red" data-filter="time" data-value="all">All</button>
                <button class="time-filter-btn red" data-filter="time" data-value="1d">&lt;1d</button>
                <button class="time-filter-btn red" data-filter="time" data-value="7d">&lt;7d</button>
                <button class="time-filter-btn red" data-filter="time" data-value="30d">&lt;30d</button>
            </div>
        </div>

        <!-- Created Date -->
        <div class="time-filter-card blue-border">
            <div class="time-filter-title blue">
                <span>&#128197;</span> Created Date
            </div>
            <div class="time-filter-options">
                <button class="time-filter-btn active blue" data-filter="created" data-value="all">All</button>
                <button class="time-filter-btn blue" data-filter="created" data-value="1d">&lt;1d</button>
                <button class="time-filter-btn blue" data-filter="created" data-value="7d">&lt;7d</button>
                <button class="time-filter-btn blue" data-filter="created" data-value="30d">&lt;30d</button>
            </div>
        </div>

        <!-- Daily Rewards -->
        <div class="time-filter-card pink-border">
            <div class="time-filter-title pink">
                <span>&#36;</span> Daily Rewards
            </div>
            <div class="time-filter-options">
                <button class="time-filter-btn active pink" data-filter="rewards" data-value="all">All</button>
                <button class="time-filter-btn pink" data-filter="rewards" data-value="20">&lt;$20</button>
                <button class="time-filter-btn pink" data-filter="rewards" data-value="20+">&gt;$20</button>
                <button class="time-filter-btn pink" data-filter="rewards" data-value="100+">&gt;$100</button>
            </div>
        </div>

        <!-- 24H Change -->
        <div class="time-filter-card orange-border">
            <div class="time-filter-title orange">
                <span>&#128200;</span> 24H Change
            </div>
            <div class="time-filter-options">
                <button class="time-filter-btn active orange" data-filter="change" data-value="all">All</button>
                <button class="time-filter-btn orange" data-filter="change" data-value="10">&lt;10%</button>
                <button class="time-filter-btn orange" data-filter="change" data-value="10+">&gt;10%</button>
                <button class="time-filter-btn orange" data-filter="change" data-value="20+">&gt;20%</button>
            </div>
        </div>
    </div>
</div>

<div class="results-count blur-fade" style="--delay: 3;" id="resultsCount">Loading markets...</div>

<div class="markets-grid blur-fade" style="--delay: 4;" id="marketsGrid">
    <div class="loading"><div class="spinner"></div></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentSort = 'score';  // Default to risky opportunities
    let markets = [];
    let filters = {
        category: 'all',
        volumeMin: 0,
        volumeMax: 100000000,
        liquidityMin: 0,
        liquidityMax: 100000000,
        spreadMinPct: 0,
        spreadMaxPct: 100000,
        timeRemaining: 'all',
        createdDate: 'all',
        dailyRewards: 'all',
        change24h: 'all'
    };

    function resetFilters() {
        filters = {
            category: 'all',
            volumeMin: 0,
            volumeMax: 100000000,
            liquidityMin: 0,
            liquidityMax: 100000000,
            spreadMinPct: 0,
            spreadMaxPct: 100000,
            timeRemaining: 'all',
            createdDate: 'all',
            dailyRewards: 'all',
            change24h: 'all'
        };

        // Reset form inputs
        document.getElementById('filterCategory').value = 'all';
        document.getElementById('volumeMin').value = '0';
        document.getElementById('volumeMax').value = '100 000 000';
        document.getElementById('liquidityMin').value = '0';
        document.getElementById('liquidityMax').value = '100 000 000';
        document.getElementById('spreadMinPct').value = '0';
        document.getElementById('spreadMaxPct').value = '100 000';

        // Reset time filter buttons
        document.querySelectorAll('.time-filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.value === 'all');
        });

        loadMarkets();
    }

    async function loadMarkets() {
        const category = document.getElementById('filterCategory').value;

        try {
            const params = new URLSearchParams({
                category,
                min_volume: filters.volumeMin,
                max_volume: filters.volumeMax,
                min_liquidity: filters.liquidityMin,
                max_liquidity: filters.liquidityMax,
                sort_by: currentSort,
                limit: 100
            });

            const res = await fetch('/api/trending?' + params);
            const data = await res.json();
            markets = data.markets || [];

            // Apply client-side filters
            markets = applyFilters(markets);

            document.getElementById('resultsCount').textContent = `Showing ${markets.length} markets`;
            renderMarkets();
        } catch (e) {
            console.error('Error loading markets:', e);
            document.getElementById('resultsCount').textContent = 'Error loading markets';
        }
    }

    function applyFilters(data) {
        return data.filter(m => {
            // Volume filter
            const vol = m.volume_24h || m.volume || 0;
            if (vol < filters.volumeMin || vol > filters.volumeMax) return false;

            // Liquidity filter
            const liq = m.liquidity || 0;
            if (liq < filters.liquidityMin || liq > filters.liquidityMax) return false;

            // Time remaining filter
            if (filters.timeRemaining !== 'all' && m.end_date) {
                const endDate = new Date(m.end_date);
                const now = new Date();
                const daysLeft = (endDate - now) / (1000 * 60 * 60 * 24);

                if (filters.timeRemaining === '1d' && daysLeft > 1) return false;
                if (filters.timeRemaining === '7d' && daysLeft > 7) return false;
                if (filters.timeRemaining === '30d' && daysLeft > 30) return false;
            }

            // 24H Change filter
            if (filters.change24h !== 'all') {
                const change = Math.abs(m.change_24h || 0) * 100;
                if (filters.change24h === '10' && change >= 10) return false;
                if (filters.change24h === '10+' && change < 10) return false;
                if (filters.change24h === '20+' && change < 20) return false;
            }

            return true;
        });
    }

    function renderMarkets() {
        const container = document.getElementById('marketsGrid');

        if (markets.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-state-icon">&#128200;</div>
                    <h3>No markets found</h3>
                    <p>Try adjusting your filters</p>
                </div>
            `;
            return;
        }

        container.innerHTML = markets.map(m => {
            const scoreClass = m.polysnap_score >= 70 ? 'hot' : m.polysnap_score >= 40 ? 'warm' : 'cool';
            const changeVal = m.change_24h || 0;
            const changeClass = changeVal >= 0 ? 'text-green' : 'text-red';
            const changeSign = changeVal >= 0 ? '+' : '';

            return `
                <div class="market-card" onclick="window.open('https://polymarket.com/event/${m.event_slug}', '_blank')">
                    <div class="market-card-header">
                        ${m.event_image ? `<img src="${m.event_image}" class="market-card-image" alt="">` : '<div class="market-card-image"></div>'}
                        <div class="market-card-info">
                            <div class="market-card-title">${m.question}</div>
                            <div class="market-card-badges">
                                <span class="badge badge-${(m.verdict || 'cool').toLowerCase()}">${m.verdict || 'COOL'}</span>
                                ${m.category ? `<span class="category-badge">${m.category}</span>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="market-card-stats">
                        <div class="market-stat">
                            <div class="market-stat-value text-blue">${(m.yes_price * 100).toFixed(0)}c</div>
                            <div class="market-stat-label">Yes Price</div>
                        </div>
                        <div class="market-stat">
                            <div class="market-stat-value text-green">${m.potential_roi ? m.potential_roi.toFixed(0) + '%' : '-'}</div>
                            <div class="market-stat-label">ROI Potential</div>
                        </div>
                        <div class="market-stat">
                            <div class="market-stat-value">${formatUSD(m.volume_24h || m.volume)}</div>
                            <div class="market-stat-label">24h Volume</div>
                        </div>
                    </div>

                    <div class="market-card-footer">
                        <div class="market-score">
                            <span class="mono" style="font-size:13px;">${m.polysnap_score || 0}</span>
                            <div class="score-bar">
                                <div class="score-fill ${scoreClass}" style="width: ${m.polysnap_score || 0}%;"></div>
                            </div>
                        </div>
                        <div class="market-change ${changeClass}">${changeSign}${(changeVal * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Event listeners for filters
    document.getElementById('filterCategory').addEventListener('change', function() {
        filters.category = this.value;
        loadMarkets();
    });

    // Range input listeners
    ['volumeMin', 'volumeMax', 'liquidityMin', 'liquidityMax', 'spreadMinPct', 'spreadMaxPct'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', function() {
                filters[id] = parseFloat(this.value) || 0;
                loadMarkets();
            });
        }
    });

    // Sort tabs
    document.querySelectorAll('.sort-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.sort-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentSort = tab.dataset.sort;
            loadMarkets();
        });
    });

    // Time filter buttons
    document.querySelectorAll('.time-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filterType = this.dataset.filter;
            const value = this.dataset.value;

            // Update active state for this filter group
            this.parentElement.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Update filter value
            if (filterType === 'time') filters.timeRemaining = value;
            if (filterType === 'created') filters.createdDate = value;
            if (filterType === 'rewards') filters.dailyRewards = value;
            if (filterType === 'change') filters.change24h = value;

            loadMarkets();
        });
    });

    // Check URL params for initial filters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('sort_by')) {
        currentSort = urlParams.get('sort_by');
        document.querySelectorAll('.sort-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.sort === currentSort);
        });
    }

    // Initialize
    loadMarkets();

    // Auto-refresh every 60 seconds
    setInterval(loadMarkets, 60000);
</script>
{% endblock %}
